name: SonarQube Scan

on:
  push:
    branches:
      - main

jobs:
  sonar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
         fetch-depth: 0 


      #setup JDK for sonar scanner beacuse sonarQube is java base application  its need JDK to run sonar scanner
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'


      # Setup Python for backend
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python deps
        run: |
          cd backend
          pip install -r requirements.txt

      # Run backend unit tests with coverage
      - name: Run backend unit tests with coverage
        run: |
          export PYTHONPATH=$PYTHONPATH:${{ github.workspace }}
          cd backend
          pip install coverage pytest pytest-cov pytest-html
          coverage erase
          mkdir -p test-reports
          PYTHONPATH=. pytest test_server.py --cov=. --cov-report=xml:coverage.xml --cov-report=html:htmlcov --junitxml=test-reports/pytest-report.xml -v
          echo "Backend Coverage Report:"
          coverage report
          echo "Coverage XML Location:"
          ls -la coverage.xml
          echo "Test Report Location:"
          ls -la test-reports/

      # Setup Node.js for frontend
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install frontend deps
        run: |
          npm install
          npm run build

      # Run frontend unit tests with coverage
      - name: Run frontend unit tests with coverage
        run: |
          npm install --save-dev jest @types/jest @testing-library/react @testing-library/jest-dom
          npm test -- --coverage
          echo "Frontend Coverage Report:"
          cat coverage/lcov.info || true
          echo "Coverage Directory Contents:"
          ls -la coverage/

      # âœ… SonarQube Scan using GitHub Action updated this
      - name: Run SonarQube Scan
        run: |
          docker run --rm \
            -e SONAR_HOST_URL=http://4.187.226.1:9000 \
            -e SONAR_TOKEN=${{ secrets.SONAR_TOKEN }} \
            -v ${{ github.workspace }}:/usr/src \
            sonarsource/sonar-scanner-cli:latest \
            -Dsonar.projectKey=dob-fact \
            -Dsonar.sources=src,backend \
            -Dsonar.tests=__tests__,backend \
            -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info \
            -Dsonar.python.coverage.reportPaths=backend/coverage.xml \
            -Dsonar.python.xunit.reportPath=backend/test-reports/pytest-report.xml \
            -Dsonar.test.inclusions=**/*test.ts,**/*test.tsx,**/test_*.py \
            -Dsonar.inclusions=**/*.ts,**/*.tsx,**/*.py \
            -Dsonar.exclusions=**/node_modules/**,**/build/**,**/dist/**,**/__pycache__/**,**/coverage/**,**/*.config.*,**/*.test.ts,**/*.test.tsx,**/test_*.py \
            -Dsonar.javascript.coveragePlugin=lcov \
            -Dsonar.sourceEncoding=UTF-8 \
            -Dsonar.scm.provider=git \
            -Dsonar.scm.forceReloadAll=true \
            -Dsonar.verbose=true

